<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Combine a database query with a cohort. — combine_query • rcprd</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Combine a database query with a cohort. — combine_query"><meta name="description" content="An S3 generic function that can be used on database queries from Aurum or GOLD extracts.
Combine a database query with a cohort, only retaining observations between time_prev days prior to indexdt, and time_post days after
indexdt, and for test data with values between lower_bound and upper_bound. The most recent numobs observations will be returned.
cohort must contain variables patid and indexdt. The type of query must be specified for appropriate data manipulation. Input type = med if
interested in medical diagnoses from the observation file, and type = test if interseted in test data from the observation file."><meta property="og:description" content="An S3 generic function that can be used on database queries from Aurum or GOLD extracts.
Combine a database query with a cohort, only retaining observations between time_prev days prior to indexdt, and time_post days after
indexdt, and for test data with values between lower_bound and upper_bound. The most recent numobs observations will be returned.
cohort must contain variables patid and indexdt. The type of query must be specified for appropriate data manipulation. Input type = med if
interested in medical diagnoses from the observation file, and type = test if interseted in test data from the observation file."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rcprd</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/rcprd.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Details-on-algorithms-for-extracting-specific-variables.html">Details-on-algorithms-for-extracting-specific-variables</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Combine a database query with a cohort.</h1>

      <div class="d-none name"><code>combine_query.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>An S3 generic function that can be used on database queries from Aurum or GOLD extracts.
Combine a database query with a cohort, only retaining observations between <code>time_prev</code> days prior to <code>indexdt</code>, and <code>time_post</code> days after
<code>indexdt</code>, and for test data with values between <code>lower_bound</code> and <code>upper_bound</code>. The most recent <code>numobs</code> observations will be returned.
<code>cohort</code> must contain variables <code>patid</code> and <code>indexdt</code>. The <code>type</code> of query must be specified for appropriate data manipulation. Input <code>type = med</code> if
interested in medical diagnoses from the observation file, and <code>type = test</code> if interseted in test data from the observation file.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">combine_query</span><span class="op">(</span></span>
<span>  <span class="va">db_query</span>,</span>
<span>  <span class="va">cohort</span>,</span>
<span>  query_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"med"</span>, <span class="st">"drug"</span>, <span class="st">"test"</span>, <span class="st">"hes_primary"</span>, <span class="st">"death"</span><span class="op">)</span>,</span>
<span>  time_prev <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  time_post <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  lower_bound <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>,</span>
<span>  upper_bound <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  numobs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  value_na_rm <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  earliest_values <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  reduce_output <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-db-query">db_query<a class="anchor" aria-label="anchor" href="#arg-db-query"></a></dt>
<dd><p>Output from database query (ideally obtained through <code><a href="db_query.html">db_query</a></code>).</p></dd>


<dt id="arg-cohort">cohort<a class="anchor" aria-label="anchor" href="#arg-cohort"></a></dt>
<dd><p>Cohort to combine with the database query.</p></dd>


<dt id="arg-query-type">query_type<a class="anchor" aria-label="anchor" href="#arg-query-type"></a></dt>
<dd><p>Type of query</p></dd>


<dt id="arg-time-prev">time_prev<a class="anchor" aria-label="anchor" href="#arg-time-prev"></a></dt>
<dd><p>Number of days prior to index date to look for codes.</p></dd>


<dt id="arg-time-post">time_post<a class="anchor" aria-label="anchor" href="#arg-time-post"></a></dt>
<dd><p>Number of days after index date to look for codes.</p></dd>


<dt id="arg-lower-bound">lower_bound<a class="anchor" aria-label="anchor" href="#arg-lower-bound"></a></dt>
<dd><p>Lower bound for returned values when <code>query_type = "test"</code>.</p></dd>


<dt id="arg-upper-bound">upper_bound<a class="anchor" aria-label="anchor" href="#arg-upper-bound"></a></dt>
<dd><p>Upper bound for returned values when <code>query_type = "test"</code>.</p></dd>


<dt id="arg-numobs">numobs<a class="anchor" aria-label="anchor" href="#arg-numobs"></a></dt>
<dd><p>Number of observations to be returned.</p></dd>


<dt id="arg-value-na-rm">value_na_rm<a class="anchor" aria-label="anchor" href="#arg-value-na-rm"></a></dt>
<dd><p>If TRUE will remove data with NA in the <code>value</code> column of the queried data and remove values outside of <code>lower_bound</code> and <code>upper_bound</code> when <code>query_type = "test"</code>.</p></dd>


<dt id="arg-earliest-values">earliest_values<a class="anchor" aria-label="anchor" href="#arg-earliest-values"></a></dt>
<dd><p>If TRUE will return the earliest values as opposed to most recent.</p></dd>


<dt id="arg-reduce-output">reduce_output<a class="anchor" aria-label="anchor" href="#arg-reduce-output"></a></dt>
<dd><p>If TRUE will reduce output to just <code>patid</code>, event date, medical/product code, and test <code>value</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data.table with observations that meet specified criteria.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><code>value_na_rm = FALSE</code> may be of use when extracting variables like smoking status, where we want test data for number of cigarettes per day,
but do not want to remove all observations with NA in the <code>value</code> column, because the medcodeid itself may indicate smoking status.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## Create connection to a temporary database</span></span></span>
<span class="r-in"><span><span class="va">aurum_extract</span> <span class="op">&lt;-</span> <span class="fu"><a href="connect_database.html">connect_database</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"temp.sqlite"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Add observation data from all observation files in specified directory</span></span></span>
<span class="r-in"><span><span class="fu"><a href="cprd_extract.html">cprd_extract</a></span><span class="op">(</span>db <span class="op">=</span> <span class="va">aurum_extract</span>,</span></span>
<span class="r-in"><span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rcprd"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>filetype <span class="op">=</span> <span class="st">"observation"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |                                                                      |   0%</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Adding /home/runner/work/_temp/Library/rcprd/aurum_data/aurum_allpatid_set1_extract_observation_001.txt 2025-03-31 10:55:07.677051</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |=======================                                               |  33%</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Adding /home/runner/work/_temp/Library/rcprd/aurum_data/aurum_allpatid_set1_extract_observation_002.txt 2025-03-31 10:55:07.715182</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |===============================================                       |  67%</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Adding /home/runner/work/_temp/Library/rcprd/aurum_data/aurum_allpatid_set1_extract_observation_003.txt 2025-03-31 10:55:07.731018</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |======================================================================| 100%</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Query database for a specific medcode</span></span></span>
<span class="r-in"><span><span class="va">db_query</span> <span class="op">&lt;-</span> <span class="fu"><a href="db_query.html">db_query</a></span><span class="op">(</span>db_open <span class="op">=</span> <span class="va">aurum_extract</span>,</span></span>
<span class="r-in"><span>tab <span class="op">=</span><span class="st">"observation"</span>,</span></span>
<span class="r-in"><span>codelist_vector <span class="op">=</span> <span class="st">"187341000000114"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Define cohort</span></span></span>
<span class="r-in"><span><span class="va">pat</span><span class="op">&lt;-</span><span class="fu"><a href="extract_cohort.html">extract_cohort</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"aurum_data"</span>, package <span class="op">=</span> <span class="st">"rcprd"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">### Add an index date to pat</span></span></span>
<span class="r-in"><span><span class="va">pat</span><span class="op">$</span><span class="va">indexdt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"01/01/2020"</span>, format <span class="op">=</span> <span class="st">"%d/%m/%Y"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Combine query with cohort retaining most recent three records</span></span></span>
<span class="r-in"><span><span class="fu">combine_query</span><span class="op">(</span>cohort <span class="op">=</span> <span class="va">pat</span>,</span></span>
<span class="r-in"><span>db_query <span class="op">=</span> <span class="va">db_query</span>,</span></span>
<span class="r-in"><span>query_type <span class="op">=</span> <span class="st">"med"</span>,</span></span>
<span class="r-in"><span>numobs <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     patid pracid.x usualgpstaffid gender   yob   mob emis_ddate regstartdate</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    &lt;char&gt;    &lt;int&gt;         &lt;char&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;Date&gt;       &lt;Date&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:      2       79             11      1  1932    NA 1979-02-14   1929-02-23</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2:      6       54             11      1  1914    NA 1926-09-09   1970-08-28</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    patienttypeid regenddate acceptable cprd_ddate    indexdt consid pracid.y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            &lt;int&gt;     &lt;Date&gt;      &lt;int&gt;     &lt;Date&gt;     &lt;Date&gt; &lt;char&gt;    &lt;int&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:            21 1945-03-19          0 1932-02-05 2020-01-01     56        1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2:            85 1983-03-14          1 1963-08-27 2020-01-01     40        1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     obsid    obsdate  enterdate staffid parentobsid       medcodeid value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;  &lt;char&gt;      &lt;char&gt;          &lt;char&gt; &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:     77 1954-03-17 1932-02-22      24           4 187341000000114    46</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2:     41 1929-09-06 1951-01-12      98          80 187341000000114    28</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    numunitid obstypeid numrangelow numrangehigh probobsid</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        &lt;int&gt;     &lt;int&gt;       &lt;num&gt;        &lt;num&gt;    &lt;char&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:        92        81          56           30        18</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2:        20         5          41           97        92</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## clean up</span></span></span>
<span class="r-in"><span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">aurum_extract</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"temp.sqlite"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Pate.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

